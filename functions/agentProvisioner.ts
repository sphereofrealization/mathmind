// Backend function: Agent provisioner for external resources via connectors\n// Schedule: every 5 minutes (via dashboard)\nimport { base44 } from "@/api/base44Client";\n\nexport default async function handler(event, ctx) {\n  const agents = await base44.entities.SiteAgent.list("-updated_date", 50);\n  for (const agent of agents) {\n    if (!agent.loop_enabled) continue;\n\n    // Skip if recently provisioned (look back last 24h)\n    const logs = await base44.entities.SiteAgentLog.filter({ agent_id: agent.id }, "-created_date", 20);\n    const recent = (logs || []).find(l => (l.summary || '').startsWith('Provisioned') && withinLastHours(l.created_date, 24));\n    if (recent) continue;\n\n    const summaries = [];\n\n    // Google Drive: create a folder for the agent\n    try {\n      const token = await base44.asServiceRole.connectors.getAccessToken('googledrive');\n      if (token) {\n        const folderName = `[Agent] ${agent.name} Research`;\n        const res = await fetch('https://www.googleapis.com/drive/v3/files', {\n          method: 'POST',\n          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },\n          body: JSON.stringify({ name: folderName, mimeType: 'application/vnd.google-apps.folder' })\n        });\n        const data = await res.json();\n        if (data && data.id) summaries.push(`Drive folder ${folderName}`);\n      }\n    } catch (e) { /* ignore; log below */ }\n\n    // Google Sheets: create a tracker sheet\n    try {\n      const token = await base44.asServiceRole.connectors.getAccessToken('googlesheets');\n      if (token) {\n        const sheetTitle = `[Agent] ${agent.name} Problem Tracker`;\n        const res = await fetch('https://sheets.googleapis.com/v4/spreadsheets', {\n          method: 'POST',\n          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },\n          body: JSON.stringify({ properties: { title: sheetTitle } })\n        });\n        const data = await res.json();\n        if (data && data.spreadsheetUrl) summaries.push(`Sheet ${sheetTitle}`);\n      }\n    } catch (e) { /* ignore; log below */ }\n\n    const ok = summaries.length > 0;\n    await base44.entities.SiteAgentLog.create({\n      agent_id: agent.id, type: 'action', success: ok, summary: ok ? `Provisioned: ${summaries.join(', ')}` : 'Provisioning skipped or not authorized', message: JSON.stringify({ created: summaries })\n    });\n  }\n}\n\nfunction withinLastHours(iso, h) {\n  try {\n    const t = new Date(iso).getTime();\n    return Date.now() - t < h * 3600 * 1000;\n  } catch { return false; }\n}\n